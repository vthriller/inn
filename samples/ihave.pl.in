#!@_PATH_PERL@
# $Id$
# ihave.pl - The ihave control message.
# Version 0.1, 19-AUG-1998
#  Parameters: params sender reply-to token site action[=log] approved
sub control_ihave {
    my $artfh;

    my @params = split(/\s+/,shift);
    my $sender = shift;
    my $replyto = shift;
    my $token = shift;
    my $site = shift;
    my ($action, $logging) = split(/=/, shift);
    my $approved = shift;

    my $pid = $$;
    my $tempfile = "$inn::tmpdir/ihave.$pid";

    my ($errmsg, $status, $nc, @component, @oldgroup, $locktry,
	$ngname, $ngdesc, $modcmd);

    if ($action eq "mail") {

	$artfh = open_article($token);
	next if (!defined($artfh));
	*ARTICLE = $artfh;

	IHHEAD: while(<ARTICLE>) { last IHHEAD if /^$/ }
	open2(\*R, \*MAIL, $inn::mailcmd, "-s",
		"ihave by $sender", $inn::newsmaster);
	while (<ARTICLE>) {
	    s/^~/~~/;
	    print MAIL $_;
	}
	close ARTICLE;
	close R;
	close MAIL;
    }
    elsif ($action eq "log") {
        if (!$logging) {
            print "ihave $sender\n";
        }
        else {
            logger($token, $logging, "ihave $sender");
        }
    }
    elsif ($action eq "doit") {
	
	open(GREPHIST, "|grephistory -i > $tempfile");
	$artfh = open_article($token);
	next if (!defined($artfh));
	*ARTICLE = $artfh;

	IHHEAD2: while(<ARTICLE>) { last IHHEAD2 if /^$/ }
	while (<ARTICLE>) { print GREPHIST $_ }
	close(ARTICLE);
	close(GREPHIST);

	if (-s "$tempfile") {
	    open2(\*R, \*INEWS, $inn::inews, "-h");
	    print INEWS "Newsgroups: to.$site\n",
			"Subject: cmsg sendme $pathhost\n",
			"Control: sendme $pathhost\n\n";
	    open TEMPFILE, "<$tempfile";
	    while(<TEMPFILE>) { print INEWS $_ }
	    close R;
            close INEWS;
	    close TEMPFILE;
        }
	unlink ($tempfile);
    }
}
