#!@_PATH_PERL@
# ihave.pl - The ihave control message.
# Version 0.1, 19-AUG-1998
#  Parameters: params sender reply-to token site action[=log] approved
sub control_ihave {
    my $artfh;

    my @params = split(/\s+/,shift);
    my $sender = shift;
    my $replyto = shift;
    my $token = shift;
    my $site = shift;
    my ($action, $logging) = split(/=/, shift);
    my $approved = shift;

    my $pid = $$;
    my $tempfile = "$inn::tmpdir/ihave.$pid";

    my ($errmsg, $status, $nc, @component, @oldgroup, $locktry,
	$ngname, $ngdesc, $modcmd);

    if ($action eq "mail") {
        open(TEMPFILE, ">$tempfile");

        $artfh = open_article($token);
        next if (!defined($artfh));
        *ARTICLE = $artfh;

        IHHEAD: while(<ARTICLE>) { last IHHEAD if /^$/ }
        while (<ARTICLE>) {
            s/^~/~~/;
            print TEMPFILE $_;
        }
        close(ARTICLE);
        close(TEMPFILE);
        system("$inn::mailcmd ".
               "-s \"ihave by $sender\" $inn::newsmaster < $tempfile");
        unlink($tempfile);
    }
    elsif ($action eq "log") {
        if (!$logging) {
            print "ihave $sender\n";
        }
        else {
            logger($token, $logging, "ihave $sender");
        }
    }
    elsif ($action eq "doit") {
        open(GREPHIST, "|grephistory -i > $tempfile");

        $artfh = open_article($token);
        next if (!defined($artfh));
        *ARTICLE = $artfh;

        IHHEAD2: while(<ARTICLE>) { last IHHEAD2 if /^$/ }
        while (<ARTICLE>) { print GREPHIST $_ }
        close(ARTICLE);
        close(GREPHIST);
        if (-s $tempfile) {
            open(TEMPFILE, "<$tempfile");
            open(INEWS, "|$inn::inews -h");
            print INEWS "Newsgroups: to.$site\n";
            print INEWS "Subject: cmsg sendme $inn::pathhost\n";
            print INEWS "Control: sendme $inn::pathhost\n\n";
            while (<TEMPFILE>) { print INEWS $_ }
            close(TEMPFILE);
            close(INEWS);
        }
        unlink($tempfile);
    }
}
