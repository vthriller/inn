#!@_PATH_PERL@
# $Id$
# version.pl - The version control message.
# Version 0.1, 19-AUG-1998
#  Parameters: params sender reply-to token site action[=log] approved
sub control_version {
    my $artfh;

    my @params = split(/\s+/,shift);
    my $sender = shift;
    my $replyto = shift;
    my $token = shift;
    my $site = shift;
    my ($action, $logging) = split(/=/, shift);
    my $approved = shift;

    my $VERSION = $inn::version;
    $VERSION = "(unknown version)" if (not $VERSION);

    my $groupname = $params[0];

    my $pid = $$;
    my $tempfile = "$inn::tmpdir/version.$pid";

    my ($errmsg, $status, $nc, @component, @oldgroup, $locktry,
	$ngname, $ngdesc, $modcmd);

    if ($action eq "mail") {
        open(TEMPFILE, ">$tempfile");
        print TEMPFILE ("$sender has requested information about your\n");
        print TEMPFILE ("news software version.\n\n");
        print TEMPFILE ("If this is acceptable, type:\n");
        print TEMPFILE ("  echo \"InterNetNews\ $VERSION\" | ",
                        "$inn::mailcmd -s \"version reply from ",
                        "$inn::pathhost\" $replyto\n\n");
        print TEMPFILE ("The control message follows:\n\n");

        $artfh = open_article($token);
        next if (!defined($artfh));
        *ARTICLE = $artfh;

        while (<ARTICLE>) { print TEMPFILE $_ }
        close(ARTICLE);
        close(TEMPFILE);
        logger($tempfile, "mail",
               "version $sender\n");
        unlink($tempfile);
    }
    elsif ($action eq "log") {
        if (!$logging) {
            print "version $sender\n";
        }
        else {
            logger($token, $logging, "version $sender");
        }
    }
    elsif ($action =~ /^(doit|doifarg)$/) {
        if (($action eq "doifarg") && ($params[0] ne $inn::pathhost)) {
            print "skipped version $sender\n";
        }
        else {
	    open2 (\*R, \*MAIL, $inn::mailcmd, "-s",
		   "version reply from $inn::pathhost", $replyto);
	    print MAIL "InterNetNews $VERSION\n";
	    close R;
	    close MAIL;
            # Now, log what we did.
            if ($logging) {
                $errmsg = "version $sender to $replyto";
                logger($token, $logging, $errmsg);
            }
        }
    }
}
