=head1 NAME

tdx-util - Tradindexed overview manipulation utility

=head1 SYNOPSIS

B<tdx-util> [B<-AFgio>] [B<-a> I<article>] [B<-n> I<newsgroup>]
[B<-p> I<path>] [B<-R> I<path>]

=head1 DESCRIPTION

B<tdx-util> is an administrative interface to the tradindexed overview
method for INN.  It only works on tradindexed overview databases, not on
any other type of INN overview.  It allows the administrator to dump
various information about the internal state of the overview, audit it for
errors, and rebuild portions of the overview database.

The tradindexed overview method should lock properly and therefore it
should be safe to run this utility and perform any operation it performs,
including full repairs or per-group overview rebuilds, while the server is
running.  However, note that some of the operations performed by this
utility can take an extended period of time and will hold locks in the
overview database during that period, which depending on what the server
is doing may cause the server to stall until B<tdx-util> completes its
operation.

The dump operations are B<-g>, which dumps the master index for the
overview database, B<-i>, which dumps the index for an individual group,
and B<-o>, which dumps the overview information for a particular group
(including the additional metadata stored in the index).  For B<-i> and
B<-o>, the B<-n> option must also be given to specify a newsgroup to
operate on.

To audit the entire overview database for problems, use B<-A>.  Any
problems found will be reported to standard error.  There is not (yet) a
corresponding option to correct the errors found.

To rebuild the database for a particular newsgroup, use B<-R>.  The B<-R>
option takes a path to a directory which contains all of the articles for
that newsgroup, one per file.  The names of the files must be the numbers
of the articles in that group.  (In other words, this directory must be a
traditional spool directory for that group.)  The B<-n> option must also
be given to specify the newsgroup for which the overview is being rebuilt.

For all operations performed by B<tdx-util>, a different overview database
than the one specified in F<inn.conf> may be specified using the B<-p>
option.

=head1 OPTIONS

=over 4

=item B<-A>

Audit the entire overview database for problems.  This runs the internal
consistency checks built into the tradindexed overview implementation,
checking such things as the validity and reachability of all group index
entries, the format of the individual overview entries, the correspondance
of index entries to overview data, and similar such things.  No changes
will be made to the database, but problems will be reported to standard
error.

=item B<-a> I<article>

The article number to act on.  Only useful in combination with the B<-o>
option to dump overview information.

=item B<-F>

Audit the entire overview database for problems, fixing them as they're
detected where possible. This runs the internal consistency checks built
into the tradindexed overview implementation, checking such things as the
validity and reachability of all group index entries, the format of the
individual overview entries, the correspondance of index entries to
overview data, and similar such things.  The strategy used when fixing
problems is to throw away data that's unrecoverable, so be warned that
using this option may result in inaccessible articles if their overview
data has been corrupted.

To see what would be changed by B<-F>, run B<tdx-util> with B<-A> first.

=item B<-g>

Dump the index of a particular group.  The fields are, in order, the
article number, the offset of the data for that article in the overview
data file for that group, the length of the overview data, the time (in
seconds since epoch) when the article arrived on the server, the time (in
seconds since epoch) when the article should expire based on its Expires
header (or 0 if there is no Expires header), and the storage API token of
the article.

If this option is given, the B<-n> option must also be given to specify
the newsgroup on which to act.

=item B<-i>

Dump the master index of the overview database.  This contains similar
information to the server active file, such as high and low water marks
and moderation status, and is the information that nnrpd hands out to
clients.

The fields are, in order, the newsgroup name, the high water mark, the low
water mark, the base article number (the point at which the group index
begins), the count of articles in the group, the group status flag, the
time (in seconds since epoch) when that newsgroup was deleted or 0 if it
hasn't been, and the inode of the index file for that group.

A particular newsgroup can be specified with the B<-n> option.  If B<-n>
is not given, the entire master index will be dumped.

=item B<-n> I<newsgroup>

Specify the newsgroup on which to act, required for the B<-i>, B<-o>, and
B<-R> options.

=item B<-o>

Dump the overview information for a newsgroup, in the same format as it
would be returned to clients but with one modification.  Appended to the
end of each entry will be four additional pieces of data:  the article
number according to the index file for that group, the storage API token
for that article, the arrival date for that article on the server in RFC
822 date format, and the expiration date for that article (from the
Expires header) in RFC 822 date format if there is any.

If this option is given, the B<-n> option must also be given to specify
the newsgroup on which to act.  By default, all of the overview
information for that newsgroup is dumped, but the B<-a> option may be
given to restrict the dump to the information for a single article.

=item B<-p> I<path>

Act on the overview database rooted in I<path>, overriding the overview
path specified in F<inn.conf>.

=item B<-R> I<path>

Rebuild the overview for a given group from the articles stored in
I<path>.  The articles must be in the form of a traditional spool
directory; in other words, each article must be in a separate file and the
name of the file must match the article number of the article.

If this option is given, the B<-n> option must also be given to specify
the newsgroup on which to act.

=back

=head1 EXAMPLES

Dump the master index for the overview database in F</news/overview>,
regardless of the overview path specified in F<inn.conf>:

    tdx-util -g -p /news/overview

Dump the group index for example.test:

    tdx-util -i -n example.test

Dump the complete overview information for example.test:

    tdx-util -o -n example.test

Audit the entire overview database for any problems:

    tdx-util -A

Rebuild the overview information for example.test from a traditional spool
directory:

    tdx-util -R /news/spool/articles/example/test -n example.test

The last command may be useful for recovering from a bad crash or
corrupted overview information for a particular group, if you are also
using the tradspool article storage method.

=head1 HISTORY

Written by Russ Allbery <rra@stanford.edu> for InterNetNews.

$Id$

=head1 SEE ALSO

makehistory(8)

=cut

