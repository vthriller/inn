.rn '' }`
''' $RCSfile$$Revision$$Date$
'''
''' $Log$
''' Revision 1.6  2000/08/29 22:03:57  kondou
''' - From: Heath Kehoe <heath.kehoe@intermec.com>
''' - new ovdb version (forgot to commit last time)
'''
'''
.de Sh
.br
.if t .Sp
.ne 5
.PP
\fB\\$1\fR
.PP
..
.de Sp
.if t .sp .5v
.if n .sp
..
.de Ip
.br
.ie \\n(.$>=3 .ne \\$3
.el .ne 3
.IP "\\$1" \\$2
..
.de Vb
.ft CW
.nf
.ne \\$1
..
.de Ve
.ft R

.fi
..
'''
'''
'''     Set up \*(-- to give an unbreakable dash;
'''     string Tr holds user defined translation string.
'''     Bell System Logo is used as a dummy character.
'''
.tr \(*W-|\(bv\*(Tr
.ie n \{\
.ds -- \(*W-
.ds PI pi
.if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\" diablo 12 pitch
.ds L" ""
.ds R" ""
'''   \*(M", \*(S", \*(N" and \*(T" are the equivalent of
'''   \*(L" and \*(R", except that they are used on ".xx" lines,
'''   such as .IP and .SH, which do another additional levels of
'''   double-quote interpretation
.ds M" """
.ds S" """
.ds N" """""
.ds T" """""
.ds L' '
.ds R' '
.ds M' '
.ds S' '
.ds N' '
.ds T' '
'br\}
.el\{\
.ds -- \(em\|
.tr \*(Tr
.ds L" ``
.ds R" ''
.ds M" ``
.ds S" ''
.ds N" ``
.ds T" ''
.ds L' `
.ds R' '
.ds M' `
.ds S' '
.ds N' `
.ds T' '
.ds PI \(*p
'br\}
.\"	If the F register is turned on, we'll generate
.\"	index entries out stderr for the following things:
.\"		TH	Title 
.\"		SH	Header
.\"		Sh	Subsection 
.\"		Ip	Item
.\"		X<>	Xref  (embedded
.\"	Of course, you have to process the output yourself
.\"	in some meaninful fashion.
.if \nF \{
.de IX
.tm Index:\\$1\t\\n%\t"\\$2"
..
.nr % 0
.rr F
.\}
.TH ovdb 5 "INN 2.3" "25/Aug/2000" "InterNetNews Documentation"
.UC
.if n .hy 0
.if n .na
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.de CQ          \" put $1 in typewriter font
.ft CW
'if n "\c
'if t \\&\\$1\c
'if n \\&\\$1\c
'if n \&"
\\&\\$2 \\$3 \\$4 \\$5 \\$6 \\$7
'.ft R
..
.\" @(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2
.	\" AM - accent mark definitions
.bd B 3
.	\" fudge factors for nroff and troff
.if n \{\
.	ds #H 0
.	ds #V .8m
.	ds #F .3m
.	ds #[ \f1
.	ds #] \fP
.\}
.if t \{\
.	ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.	ds #V .6m
.	ds #F 0
.	ds #[ \&
.	ds #] \&
.\}
.	\" simple accents for nroff and troff
.if n \{\
.	ds ' \&
.	ds ` \&
.	ds ^ \&
.	ds , \&
.	ds ~ ~
.	ds ? ?
.	ds ! !
.	ds /
.	ds q
.\}
.if t \{\
.	ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.	ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.	ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.	ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.	ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.	ds ? \s-2c\h'-\w'c'u*7/10'\u\h'\*(#H'\zi\d\s+2\h'\w'c'u*8/10'
.	ds ! \s-2\(or\s+2\h'-\w'\(or'u'\v'-.8m'.\v'.8m'
.	ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.	ds q o\h'-\w'o'u*8/10'\s-4\v'.4m'\z\(*i\v'-.4m'\s+4\h'\w'o'u*8/10'
.\}
.	\" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds v \\k:\h'-(\\n(.wu*9/10-\*(#H)'\v'-\*(#V'\*(#[\s-4v\s0\v'\*(#V'\h'|\\n:u'\*(#]
.ds _ \\k:\h'-(\\n(.wu*9/10-\*(#H+(\*(#F*2/3))'\v'-.4m'\z\(hy\v'.4m'\h'|\\n:u'
.ds . \\k:\h'-(\\n(.wu*8/10)'\v'\*(#V*4/10'\z.\v'-\*(#V*4/10'\h'|\\n:u'
.ds 3 \*(#[\v'.2m'\s-2\&3\s0\v'-.2m'\*(#]
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.ds oe o\h'-(\w'o'u*4/10)'e
.ds Oe O\h'-(\w'O'u*4/10)'E
.	\" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.	\" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.	ds : e
.	ds 8 ss
.	ds v \h'-1'\o'\(aa\(ga'
.	ds _ \h'-1'^
.	ds . \h'-1'.
.	ds 3 3
.	ds o a
.	ds d- d\h'-1'\(ga
.	ds D- D\h'-1'\(hy
.	ds th \o'bp'
.	ds Th \o'LP'
.	ds ae ae
.	ds Ae AE
.	ds oe oe
.	ds Oe OE
.\}
.rm #[ #] #H #V #F C
.SH "NAME"
ovdb \- Overview storage method for INN
.SH "DESCRIPTION"
Ovdb is a storage method that uses the BerkeleyDB library to store overview
data.  It requires version 2.6.x or later of the BerkeleyDB library; it is
known to work well with version 2.7.7.  The latest released version, 3.1.17,
appears to work, but hasn't been tested as much.  Check the
web page http://www.avalon.net/~hakehoe/inn/ for the latest on BerkeleyDB
compatibility.
.PP
Ovdb makes use of the full transaction/logging/locking functionality of the
BerkeleyDB environment.  BerkeleyDB may be downloaded from
http://www.sleepycat.com .
.PP
The BerkeleyDB distribution is (by default) installed into
\fI/usr/local/BerkeleyDB\fR, with subdirectories \fIlib/\fR, \fIinclude/\fR, and
\fIbin/\fR for the library, headers, and support tools, respectively.
Version 3.x uses \fI/usr/local/BerkeleyDB.3.x\fR instead.
.SH "INSTALLATION"
To build ovdb support into INN, specify the option \f(CW--with-berkeleydb\fR
when running the configure script.  By default, configure will search
for a BerkeleyDB tree in several likely locations, and choose the highest
version (based on the name of the directory, e.g., \fIBerkeleyDB.3.0\fR)
that it finds.  There will be a message in the configure output
indicating the chosen pathname.
.PP
You can override this pathname by adding a path to the option, e.g.,
\f(CW--with-berkeleydb=/usr/BerkeleyDB.3.1\fR.  This directory is expected
to have subdirectories \fIinclude\fR and \fIlib\fR, containing
\fIdb.h\fR, and the library itself, respectively.
.PP
The ovdb database will take up more disk space for a given spool than
the other overview methods.  Plan on needing at least 1.1 KB for every
article in your spool (not counting crossposts).  So, if you have 5
million articles, you'll need at least 5.5 GB of disk space for ovdb.
With BerkeleyDB 2.x, the db files are \*(L'grow only\*(R'; the library will
not shrink them, even if data is removed.  So, reserving extra space
above the estimate is a good idea.
Plus, you'll need additional space for transaction logs: at least 100 MB.
By default the transaction logs go in the same directory as the database.
To improve performance, they can be placed on a different disk -- see
the DB_CONFIG section.
.SH "CONFIGURATION"
To enable ovdb, set the \fIovmethod\fR parameter in \fIinn.conf\fR to \f(CWovdb\fR.
The ovdb database is stored in the directory specified by the \fIpathoverview\fR
paramter in \fIinn.conf\fR.  This is the \*(L"DB_HOME\*(R" directory.  To start out,
this directory should be empty (other than an optional \fIDB_CONFIG\fR file,
see the DB_CONFIG section for details) and innd (or makehistory) will
create the files as necessary in that directory.  Make sure the directory
is owned by the news user.
.PP
Other parameters for configuring ovdb are in the optional \fIovdb.conf\fR
configuration file.  See also the sample \fIovdb.conf\fR.
.Ip "numdbfiles" 4
Overview data is split between this many files.  Currently,
innd will keep all of the files open, so don't set this too high
or innd may run out of file descriptors.  The nnrpds only open one
at a time, regardless.  May be set to one, or just a few, but only
do that if your \s-1OS\s0 supports large (>2G) files.  Changing this
parameter has no effect on an already-established database.
Default is 32.
.Ip "txn_nosync" 4
If txn_nosync is set to false, BerkeleyDB flushes the log after every
transaction.  This minimizes the number of transactions that may be lost
in the event of a crash, but results in significantly degraded
performance.  Default is true.
.Ip "cachesize" 4
Size of the memory pool cache, in Kilobytes.  The cache will have a
backing store file in the \s-1DB\s0 directory which will be at least as big.
In general, the bigger the cache, the better.  Use \f(CWovdb_stat -m\fR to see
cache hit percentages.  If they're less than 80%, try increasing the
cache size.  To make a change of this parameter take effect, shut down
and restart \s-1INN\s0 (be sure to kill all of the nnrpds when shutting down).
Default is 8000, which is adequate for small to medium sized servers.
Large servers will probably need at least 14000.
.Ip "pagesize" 4
Sets the page size for the \s-1DB\s0 files (in bytes).  Must be a power of 2.
Best choices are 4096 or 8192.  The default is 8192.
Changing this parameter has no effect on an already-established database.
.Ip "minkey" 4
Sets the minimum number of keys per page.  See the BerkeleyDB
documentation for more info.  Default is based on page size:
.Sp
.Vb 1
\& default_minkey = MAX(2, pagesize / 2048 - 1)
.Ve
The lowest allowed minkey is 2.  Setting minkey higher than the
default is not recommended, as it will cause the databases to have
a lot of overflow pages.
Changing this parameter has no effect on an already-established database.
.Ip "maxlocks" 4
Sets the BerkeleyDB \*(L"lk_max\*(R" parameter, which is the maxmium number
of locks that can exist in the database at the same time.  Default
is 4000.
.Ip "nocompact" 4
The nocompact parameter affects expireover's behavior.  The expireover
function in ovdb can do its job in one of two ways:  By simply deleting
expired records from the database; or by re-writing the overview records
into a different location leaving out the expired records.  The first
method is faster, but it leaves \*(L'holes\*(R' that result in space that can
not immediately be reused.  The second method \*(L'compacts\*(R' the records
by rewriting them.
.Sp
If this parameter is set to 0, expireover will compact all newsgroups;
if set to 1, expireover will not compact any newsgroups; and if set to
a value greater than one, expireover will only compact groups that
have less than that number of articles.  Default is 10000.
.Sh "\s-1DB_CONFIG\s0"
A file called \fI\s-1DB_CONFIG\s0\fR may be placed in the database directory to
customize where the various database files and transaction logs are
written.  By default, all of the files are written in the \*(L"\s-1DB_HOME\s0\*(R"
directory.  One way to improve performance is to put the transaction
logs on a different disk.  To do this, put:
.PP
\s-1DB_LOG_DIR\s0 /path/to/logs
.PP
in the \fI\s-1DB_CONFIG\s0\fR file.  If the pathname you give starts with a /,
it is treated as an absolute path; otherwise, it is relative to the
\*(L"\s-1DB_HOME\s0\*(R" directory.  Make sure that any directories you specify 
exist and have proper ownership/mode before starting \s-1INN\s0, because 
they won't be created automatically.  Also, don't change the \s-1DB_CONFIG\s0
file while anything that uses ovdb is running.
.PP
The \s-1DB_CONFIG\s0 functionality is part of BerkeleyDB itself.
.SH "RUNNING"
When starting the news system, \f(CWrc.news\fR will invoke \f(CWovdb_init\fR.
\f(CWovdb_init\fR must be run before using the database.  It performs
the following tasks:
.Ip "\(bu" 4
Creates the database environment, if necessary
.Ip "\(bu" 4
If the database is idle, it performs a normal recovery.  The
recovery will remove stale locks, recreate the memory pool cache,
and repair the damage that may result from a system crash or
improper shutdown.
.Ip "\(bu" 4
Starts the \s-1DB\s0 housekeeping processes (ovdb_monitor) if they're not
already running.
.PP
And when stopping \s-1INN\s0, \fIrc.news\fR kills the ovdb_monitor processes after the
other \s-1INN\s0 processes have been shut down.
.SH "DIAGNOSTICS"
Problems relating to ovdb are logged to news.err with \*(L"OVDB\*(R" in the
error message.
.PP
INN programs that use overview will fail to start up if the
ovdb_monitor processes aren't running.  Be sure to run \f(CWovdb_init\fR
before running anything that accesses overview.
.PP
If a program accessing the database crashes, or otherwise exits
uncleanly, it might leave a stale lock in the database.  This lock
could cause other processes to deadlock on that stale lock.  To
fix this, shut down all news processes (using
\f(CWkill -9\fR if necessary) and then restart.  \f(CWovdb_init\fR should
perform a recovery operation which will remove the locks and repair
damage caused by killing the deadlocked processes.
.SH "FILES"
.Ip "inn.conf" 4
The \fIovmethod\fR and \fIpathoverview\fR parameters are relevant to ovdb.
.Ip "ovdb.conf" 4
Optional configuration file for tuning.  See \s-1CONFIGURATION\s0 section above.
.Ip "\fIpathoverview\fR" 4
Directory where the database goes.  BerkeleyDB calls it the \*(L'\s-1DB_HOME\s0\*(R'
directory.
.Ip "\fIpathoverview\fR/\s-1DB_CONFIG\s0" 4
Optional file to configure the layout of the database files.
.Ip "\fIpathrun\fR/ovdb.sem" 4
A file that gets locked by every process that is accessing the database.
This is used by ovdb_init to determine whether the database is active
or quiescent.
.Ip "\fIpathrun\fR/ovdb_monitor.pid" 4
Contains the process \s-1ID\s0 of ovdb_monitor.
.SH "TO DO"
Implement a way to limit how many databases can be open at once (to
reduce file descriptor usage); maybe using something similar to the
cache code in ov3.c
.SH "HISTORY"
Written by Heath Kehoe <hakehoe@avalon.net> for InterNetNews
.SH "SEE ALSO"
rc.\fInews\fR\|(8), inn.\fIconf\fR\|(5), \fIovdb_init\fR\|(8), \fIovdb_monitor\fR\|(8), \fIovdb_stat\fR\|(8)
.PP
BerkeleyDB documentation: in the \fIdocs\fR directory of the BerkeleyDB
source distribution, or on the Sleepycat web page: http://www.sleepycat.com/

.rn }` ''
.IX Title "ovdb 5"
.IX Name "ovdb - Overview storage method for INN"

.IX Header "NAME"

.IX Header "DESCRIPTION"

.IX Header "INSTALLATION"

.IX Header "CONFIGURATION"

.IX Item "numdbfiles"

.IX Item "txn_nosync"

.IX Item "cachesize"

.IX Item "pagesize"

.IX Item "minkey"

.IX Item "maxlocks"

.IX Item "nocompact"

.IX Subsection "\s-1DB_CONFIG\s0"

.IX Header "RUNNING"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Item "\(bu"

.IX Header "DIAGNOSTICS"

.IX Header "FILES"

.IX Item "inn.conf"

.IX Item "ovdb.conf"

.IX Item "\fIpathoverview\fR"

.IX Item "\fIpathoverview\fR/\s-1DB_CONFIG\s0"

.IX Item "\fIpathrun\fR/ovdb.sem"

.IX Item "\fIpathrun\fR/ovdb_monitor.pid"

.IX Header "TO DO"

.IX Header "HISTORY"

.IX Header "SEE ALSO"

