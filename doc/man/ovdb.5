.\" Automatically generated by Pod::Man version 1.02
.\" Fri Jun  9 00:11:13 2000
.\"
.\" Standard preamble:
.\" ======================================================================
.de Sh \" Subsection heading
.br
.if t .Sp
.ne 5
.PP
\fB\\$1\fR
.PP
..
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Ip \" List item
.br
.ie \\n(.$>=3 .ne \\$3
.el .ne 3
.IP "\\$1" \\$2
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R

.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  | will give a
.\" real vertical bar.  \*(C+ will give a nicer C++.  Capital omega is used
.\" to do unbreakable dashes and therefore won't be available.  \*(C` and
.\" \*(C' expand to `' in nroff, nothing in troff, for use with C<>
.tr \(*W-|\(bv\*(Tr
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` `
.    ds C' '
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
'br\}
.\"
.\" If the F register is turned on, we'll generate index entries on stderr
.\" for titles (.TH), headers (.SH), subsections (.Sh), items (.Ip), and
.\" index entries marked with X<> in POD.  Of course, you'll have to process
.\" the output yourself in some meaningful fashion.
.if \nF \{\
.    de IX
.    tm Index:\\$1\t\\n%\t"\\$2"
.    .
.    nr % 0
.    rr F
.\}
.\"
.\" For nroff, turn off justification.  Always turn off hyphenation; it
.\" makes way too many mistakes in technical documents.
.hy 0
.if n .na
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.bd B 3
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ======================================================================
.\"
.IX Title "ovdb 5"
.TH ovdb 5 "INN 2.3" "2000-06-09" "InterNetNews Documentation"
.UC
.SH "NAME"
ovdb \- Overview storage method for \s-1INN\s0
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
Ovdb is a storage method that uses the BerkeleyDB library to store overview
data.  It requires version 2.6.x or later of the BerkeleyDB library; it is
known to work well with version 2.7.7.  There is also a 3.0.55, but it is
not very stable (though ovdb will compile correctly with it).  Check the
web page http://www.avalon.net/~hakehoe/inn/ for the latest on BerkeleyDB
compatibility.
.PP
Ovdb makes use of the full transaction/logging/locking functionality of the
BerkeleyDB environment.  BerkeleyDB may be downloaded from
http://www.sleepycat.com .
.PP
The BerkeleyDB distribution is (by default) installed into
\&\fI/usr/local/BerkeleyDB\fR, with subdirectories \fIlib/\fR, \fIinclude/\fR, and
\&\fIbin/\fR for the library, headers, and support tools, respectively.
Version 3.x uses \fI/usr/local/BerkeleyDB.3.x\fR instead.
Ovdb uses some of the support tools in the \fIbin/\fR subdirectory; namely
\&\fIdb_archive\fR, \fIdb_checkpoint\fR, and \fIdb_deadlock\fR.
.SH "INSTALLATION"
.IX Header "INSTALLATION"
To build ovdb support into \s-1INN\s0, specify the option \f(CW\*(C`\-\-with\-berkeleydb\*(C'\fR
when running the configure script.  By default, configure will use
\&\fI/usr/local/BerkeleyDB\fR.
If you installed it in a different location, you'll need to specify
that location like this (for example): \f(CW\*(C`\-\-with\-berkeleydb=/opt/BerkeleyDB\*(C'\fR.
.PP
The ovdb database will take up more disk space for a given spool than
the other overview methods.  Plan on needing at least 1.1 \s-1KB\s0 for every
article in your spool (not counting crossposts).  So, if you have 5
million articles, you'll need at least 5.5 \s-1GB\s0 of disk space for ovdb.
With BerkeleyDB 2.x, the db files are 'grow only'; the library will
not shrink them, even if data is removed.  So, reserving extra space
above the estimate is a good idea.
Plus, you'll need additional space for transaction logs: at least 40 \s-1MB\s0,
preferably 100 \s-1MB\s0.  (The logs may be on a different filesystem
\&\-\- see the \s-1DB_CONFIG\s0 section.)
.SH "CONFIGURATION"
.IX Header "CONFIGURATION"
To enable ovdb, set the \fIovmethod\fR parameter in \fIinn.conf\fR to \f(CW\*(C`ovdb\*(C'\fR.
The ovdb database is stored in the directory specified by the \fIpathoverview\fR
paramter in \fIinn.conf\fR.  This is the \*(L"\s-1DB_HOME\s0\*(R" directory.  To start out,
this directory should be empty (other than an optional \fI\s-1DB_CONFIG\s0\fR file,
see the \s-1DB_CONFIG\s0 section for details) and innd (or makehistory) will
create the files as necessary in that directory.
.PP
Other parameters for configuring ovdb are in the optional \fIovdb.conf\fR
configuration file.  See also the sample \fIovdb.conf\fR.
.Ip "numdbfiles" 4
.IX Item "numdbfiles"
Overview data is split between this many files.  Currently,
innd will keep all of the files open, so don't set this too high
or innd may run out of file descriptors.  The nnrpds only open one
at a time, regardless.  May be set to one, or just a few, but only
do that if your \s-1OS\s0 supports large (>2G) files.
Warning: do \s-1NOT\s0 change this on an already established database.
Default is 32.
.Ip "txn_nosync" 4
.IX Item "txn_nosync"
If txn_nosync is set to false, BerkeleyDB flushes the log after every
transaction.  This minimizes the number of transactions that may be lost
in the event of a crash, but results in significantly degraded
performance.  Default is true.
.Ip "cachesize" 4
.IX Item "cachesize"
Size of the memory pool cache, in Kilobytes.  The cache will have a
backing store file in the \s-1DB\s0 directory which will be at least as big.
In general, the bigger the cache, the better.  Use \f(CW\*(C`db_stat \-m\*(C'\fR to see
cache hit percentages.  If they're less than 80%, try increasing the
cache size.  To make a change of this parameter take effect with an
existing database, remove the \fI_\|_db*\fR files while there are no
database processes running.  Default is 8000 K, which may be
adequate for small to medium-sized servers.  Full-feed servers will
probably need at least 14000.
.Ip "pagesize" 4
.IX Item "pagesize"
Sets the page size for the \s-1DB\s0 files (in bytes).  Must be a power of 2.
Best choices are 4096, 8192, or 16384.  The default is 8192.
You can not change the pagesize of an existing \s-1DB\s0, it must be recreated.
.Ip "minkey" 4
.IX Item "minkey"
Sets the minimum number of keys per page.  See the BerkeleyDB
documentation for more info.  Default is based on page size:
.Sp
.Vb 1
\& default_minkey = pagesize / 2048
.Ve
You can not change the minkey of an existing \s-1DB\s0, it must be recreated.
.Sh "\s-1DB_CONFIG\s0"
.IX Subsection "DB_CONFIG"
A file called \fI\s-1DB_CONFIG\s0\fR may be placed in the database directory to
customize where the various database files and transaction logs are
written.  By default, all of the files are written in the \*(L"\s-1DB_HOME\s0\*(R"
directory.  One way to improve performance is to put the transaction
logs on a different disk.  To do this, put:
.PP
\&\s-1DB_LOG_DIR\s0 /path/to/logs
.PP
in the \fI\s-1DB_CONFIG\s0\fR file.  If the pathname you give starts with a /,
it is treated as an absolute path; otherwise, it is relative to the
\&\*(L"\s-1DB_HOME\s0\*(R" directory.  Make sure that any directories you specify 
exist and have proper ownership/mode before starting \s-1INN\s0, because 
they won't be created automatically.  Also, don't change the \s-1DB_CONFIG\s0
file while anything that uses ovdb is running.
.PP
The \s-1DB_CONFIG\s0 functionality is part of BerkeleyDB itself.
.SH "RUNNING"
.IX Header "RUNNING"
You don't need to do anything special when starting or stopping \s-1INN\s0
when using ovdb, as long as you use \fIrc.news\fR.  When starting,
\&\fIrc.news\fR:
.Ip "\(bu" 4
Runs \f(CW\*(C`ovdb_recover\*(C'\fR.  This will perform any needed recovery on the
database; e.g., if there was a crash that may have left the database
in an inconsistent state.  This is done before innd is started.  If
the innd.pid file is present but innd is not running (i.e., unclean
shutdown), rc.news will supply the \f(CW\*(C`\-f\*(C'\fR argument to \f(CW\*(C`ovdb_recover\*(C'\fR
.Ip "\(bu" 4
Runs \f(CW\*(C`dbprocs start\*(C'\fR.  This starts the \s-1DB\s0 housekeeping processes.
.PP
And when stopping \s-1INN\s0, \fIrc.news\fR calls \f(CW\*(C`dbprocs stop\*(C'\fR after the
other \s-1INN\s0 processes have been shut down.
.SH "DIAGNOSTICS"
.IX Header "DIAGNOSTICS"
Problems relating to ovdb are logged to news.err with \*(L"\s-1OVDB\s0\*(R" in the
error message.
.PP
If a program accessing the database crashes, or otherwise exits
uncleanly, it might leave a stale lock in the database.  This lock
could cause other processes to deadlock on that stale lock.  To
fix this, shut down all news processes (using
\&\f(CW\*(C`kill \-9\*(C'\fR if necessary) then run \f(CW\*(C`ovdb_recover \-f\*(C'\fR as the
news user, e.g.: \f(CW\*(C`su news \-c "/PATHBIN/ovdb_recover \-f"\*(C'\fR
This will remove all locks plus repair any damage caused by
killing deadlocked processes.
.SH "FILES"
.IX Header "FILES"
.Ip "inn.conf" 4
.IX Item "inn.conf"
The \fIovmethod\fR and \fIpathoverview\fR parameters are relevant to ovdb.
.Ip "ovdb.conf" 4
.IX Item "vdb.conf"
Optional configuration file for tuning.  See \s-1CONFIGURATION\s0 section above.
.Ip "\fIpathoverview\fR" 4
.IX Item "pathoverview"
Directory where the database goes.  BerkeleyDB calls it the '\s-1DB_HOME\s0'
directory.
.Ip "\fIpathoverview\fR/DB_CONFIG" 4
.IX Item "pathoverview/DB_CONFIG"
Optional file to configure the layout of the database files.
.SH "TO DO"
.IX Header "TO DO"
I've modified innshellvars and innshellvars.pl to add the BerkeleyDB
bin dir to \s-1PATH\s0 and set \s-1DB_HOME\s0 to innconf->pathoverview.  Since I
don't know \s-1TCL\s0, someone needs to modify innshellvars.tcl in the same
way.
.PP
Implement a way to limit how many databases can be open at once (to
reduce file descriptor usage); maybe using something similar to the
cache code in ov3.c
.SH "HISTORY"
.IX Header "HISTORY"
Written by Heath Kehoe <hakehoe@avalon.net> for InterNetNews
.SH "SEE ALSO"
.IX Header "SEE ALSO"
\&\fIrc.news\fR\|(8), \fIinn.conf\fR\|(5), \fIdbprocs\fR\|(8), \fIovdb_recover\fR\|(8), \fIovdb_upgrade\fR\|(8)
.PP
BerkeleyDB documentation, in the \fIdocs\fR directory of the BerkeleyDB
source distribution, or on the Sleepycat web page: http://www.sleepycat.com/
