.\" $Revision$
.TH MAKEHISTORY 8
.SH NAME
makehistory \- tools to recover Usenet history database.
.SH SYNOPSIS
.B makehistory
[
.BI \-A " oldtmp"
]
[
.BI \-a " active"
]
[
.B \-b
]
[
.BI \-D " dir"
]
[
.BI \-d " dir"
]
[
.BI \-f " filename"
]
[
.BI \-h " file"
]
[
.BI \-I " file"
]
[
.B \-i
]
[
.B \-n
]
[
.B \-O
]
[
.B \-o
]
[
.B \-R
]
[
.B \-r
]
[
.B \-S
]
[
.BI \-s " size"
]
[
.BI \-T " tmpdir"
]
[
.B \-t " [ H|h|S|s ]"
]
[
.B \-U
]
[
.B \-u
]
[
.B \-v
]
[
.B \-x
]
.SH DESCRIPTION
.PP
.I Makehistory
rebuilds the
.IR history (5)
text file and the associated
.IR dbz (3)
database.
The default name of the text file is
.IR <pathdb\ in\ inn.conf>/history ;
to specify a different name, use the ``\fB\-f\fP'' flag.
.I Makehistory
scans the
.IR active (5)
file to determine which newsgroup directories within the spool directory,
.IR <patharticles\ in\ inn.conf> ,
should be scanned.
(If a group is removed, but its spool directory still exists,
.I makehistory
will ignore it.)
The program reads each file found and writes a history line for it.
.PP
.I Makehistory
also restores articles stored by traditional method through storage api.
If this is done, unified overview database and its index can be created
together.  The translation into traditional method is not supported.
.PP
After the text file is written,
.I makehistory
will build the
.I dbz
database.
.SH OPTIONS
.TP
.B \-A
If the ``\fB\-A\fP'' flag is used then the argument given is the pathname
.I makehistory
can use to store a copy of the history file as it's being built. It will be
appended to, so existing data will not be lost (and so should be valid
history entries).
.TP
.B \-a
If the ``\fB\-a\fP'' flag is given then the argument is the active file to
use rather than the default one of
.IR <pathdb\ in\ inn.conf>/active .
.TP
.B \-b
If the ``\-b'' flag is used, then
.I makehistory
will remove any articles that do not have valid Message-ID headers in them.
.TP
.B \-D
If the ``\fB\-D\fP'' flag is used, then
.I dir
is used as traditional spool directory.  This directory is used for
translating traditional stored articles into new storing method through storage
api.  The default is
.IR <patharticles\ in\ inn.conf> .
This flag is valid if ``\fB\-t\fP'' flag is used.
.TP
.B \-d
If the ``\fB\-d\fP'' flag is used, then
.I dir
is used as overview directory.  This directory is used for
translating traditional stored articles into new storing method through storage
api.  The default is
.IR <pathoverview\ in\ inn.conf> .
This flag is valid if ``\fB\-t\fP'' flag is used.
.TP
.B \-f
If the ``\fB\-f\fP'' flag is used, then the database files are named
.I file.dir
,
.I file.index
and
.IR file.hash .
If the ``\fB\-f\fP'' flag is not used, then a temporary link to the name
.I history.n
is made and the database files are written as
.I history.n.index
,
.I history.n.hash
and
.IR history.n.dir .
.TP
.B \-h
If the ``\fB\-h\fP'' flag is used, then
.I file
is used as old history.  This file is used for translating traditional
stored articles into new storing method through storage api.  The default
is
.IR <pathdb\ in\ inn.conf>/history .
This flag is valid if ``\fB\-t\fP'' flag is used.
.TP
.B \-I
If the ``\fB\-I\fP'' flag is used, then the index of article overview are
appended to the specified
.IR file .
This file can be created if storage api is used and ``\fB\-O\fP'' flag
is used.  With this
.IR file ,
you can make new overview index file.  To do this,
.PP
.RS
.nf
sort -t' ' +1 -2 file \&| <PREFIX specified with --prefix at configure>/expireindex -a -o -z
.fi
.sp 1
If translation is done based on history, the ``\fB\-I\fP'' and ``\fB\-O\fP''
flag is used without ``\fB\-R\fP'' flag and the article is stored through
storage api,
.I makehistory
just makes index for overview data and history.  In case that only index for
overview data needed to be created, use the ``\fB\-x\fP'' flag not to
create new history.
.RE
.TP
.B \-i
To ignore the old database use the ``\fB\-i\fP'' flag.
Using the ``\fB\-o\fP'' flag implies the ``\fB\-i\fP'' flag.
.TP
.B \-O
If the ``\fB\-O\fP'' flag is used, then overview database is also created.
This is used for translating traditional stored articles into new storing
method through storage api.
Note that if the ``\fB\-O\fP'' flag is used, existing overview database
will be overwritten.  To avoid this behavior, use ``\fB\-d\fP'' flag to
specify another overview directory.
.TP
.B \-o
If the ``\fB\-o\fP'' flag is used, then the link is not made and any existing
history files are overwritten.
If the old database exists,
.I makehistory
will use it to determine the size of the new database.
.sp 1
Note if ``\fB\-t\fP'' with ``H'' or ``h'' is specified together, ``\fB\-o\fP''
will break old history and the operation is failed.
.TP
.B \-n
To scan the spool directory without rebuilding the
.I dbz
files, use the ``\fB\-n\fP'' flag.
If used with ``\fB-u\fP'', the server will not be throttled while scanning.
.TP
.B \-R
If the ``\fB\-R\fP'' flag is used, then old articles are removed if translation
is done.  This is used for translating traditional stored articles into new
storing method through storage api.
This flag is valid if ``\fB\-t\fP'' flag is used.
.TP
.B \-r
To just build the
.I dbz
files from an existing text file, use the ``\fB\-r\fP'' flag.
The ``\fB\-i\fP'' or ``\fB\-s\fP'' flags can be useful if there are no valid
.I dbz
files to use.
.TP
.B \-S
If the ``\fB\-S\fP'' flag is used, then articles stored by traditional method
are ignored.  This is used for translating traditional stored articles into new
storing method through storage api.
.TP
.B \-s
The program will also ignore any old database if the ``\fB\-s\fP'' flag is used
to specify the approximate number of entries in the new database.
Accurately specifying the size is an optimization that will create a more
efficient database.
(The size should be the estimated eventual size of the file, typically
the size of the old file.)
For more information, see the discussion of
.I dbzfresh
and
.I dbzsize
in
.IR dbz (3).
.TP
.B \-T
.I Makehistory
needs to create a temporary file that contains one line for each article
it finds, which can become very large.
This file is created in the
.I <pathtmp in inn.conf>
directory.  The ``\fB\-T\fP'' flag may be used to
specify a temporary directory.  In addition, the
.IR sort (1)
that is invoked during the build writes large temporary files (often to
.IR /var/tmp
but see your system manpages).  If the ``\fB\-T\fP'' flag is used, then the
flag and its value will be passed to
.IR sort .
On most systems this will change the temporary directory that
.I sort
uses.
If used, this flag and its value will be passed on to the
.IR sort (1)
command that is invoked during the build.
.TP
.B \-t
If the ``\fB\-t\fP'' flag is used, then 
.I makehistory
translates stored articles into new storing method through
storage api.  With an additional flag, 
.I makehistory
determines to how to retrieve traditional stored articles.
.sp 1
.in +0.5i
.nf
H       retrieve from history
h       same as H
S       retrieve from spool
s       same as S
.fi
.in -0.5i
.sp 1
Retrieving from history translates articles stored by both traditional method
and storage api.  Retrieving from spool will only translates articles stored by
traditional method.
Normally, translation from spool takes longer time, since
.I makehistory
reads every directory for each newsgroup in
.IR active (5)
even if no article exists.
.sp 1
If translating from spool,
.I makehistory
adds ``Xref'' header with pathname, if the article has no ``Xref'' header.
If
.I makehistory
does this, the article is assumed not to be crossposted.
.sp 1
\&``\fB\-t\fP'' flag and ``\fB\-u\fP'' cannot be used together.
.TP
.B \-U
If the ``\fB\-U\fP'' flag is used, then any crossposted (linked) articles
are removed if translation is done.  This is used for translating traditional
stored articles into new storing method through storage api.
This flag is valid if ``\fB\-t\fP'' flag is used.
If ``\fB\-U\fP'' flag is not used even if ``\fB\-t\fP'' flag is used,
there still remain all crossposted (linked) articles, and 
.TP
.B \-u
If the ``\fB\-u\fP'' flag is given, then
.I makehistory
assumes that
.I innd
is running.
It will throttle the server while scanning, and then
send ``addhist'' commands (see
.IR ctlinnd (8))
to the server for any article that is not found in the
.I dbz
database.
The command ``makehistory\ \-bu'' is useful after a system crash, to delete
any mangled articles and bring the article database back into a more
consistent state.
.TP
.B \-v
If the ``\fB\-v\fP'' flag is used with the ``\fB\-u\fP'' flag, then
.I makehistory
will put a copy of all added lines on its standard output.
.TP
.B \-x
If the ``\fB\-x\fP'' flag is used,
.I makehistory
will never write history.
This flag is valid only if the ``\fB\-t\fP'' with ``h'' and ``\fB\-O\fP'' is
used without ``\fB\-R\fP'' flag.
.TP
.SH EXAMPLES
.PP
A typical way to use this program is with the following
.I /bin/sh
commands:
.PP
.RS
.nf
ctlinnd throttle "Rebuilding history file"
cd <pathetc in inn.conf>
if makehistory \-n \-f history.n ; then
    :
else
    echo Error creating history file!
    exit 1
f\&i
# The following line can be used to retain expired history
# It is not necessary for the history file to be sorted.
# awk 'NF==2 { print; }' <history >>history.n
# View history file for mistakes.
if makehistory \-r \-s `wc \-l <history` \-f history.n; then
    mv history.n history
    mv history.n.dir history.dir
# if <DBZ_TAGGED_HASH in config.data> is DO
    mv history.n.pag history.pag
# else DONT
    mv history.n.index history.index
    mv history.n.hash history.hash
# fi
f\&i
ctlinnd go ''
.fi
.RE
.SH BUGS AND LIMITATIONS
.PP
.I Makehistory
does not handle symbolic links.
If the news spool area is split across multiple partitions, the following
commands should probably be run before the database is regenerated:
.RS
.nf
cd <patharticles in inn.conf>
find . -type l -name '[1-9][0-9]*' -print | xargs -t rm
.fi
.RE
Make sure to run the command on all the appropriate partitions!
.SH HISTORY
Written by Rich $alz <rsalz@uunet.uu.net> for InterNetNews.
.de R$
This is revision \\$3, dated \\$4.
..
.R$ $Id$
.SH "SEE ALSO"
active(5),
ctlinnd(8),
dbz(3),
filechan(8),
history(5),
inn.conf(5),
innd(8),
newsfeeds(5),
makeactive(8),
newsrequeue(8).
